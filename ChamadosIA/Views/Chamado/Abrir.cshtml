@model ChamadosIA.Models.Chamado
@{
    ViewData["Title"] = "Abrir Chamado";
}

<link rel="stylesheet" href="~/css/site.css" />

<style>
    .form-container {
        max-width: 700px;
        margin: 60px auto;
        background: linear-gradient(to right, #6dd5ed, #2193b0);
        border-radius: 12px;
        padding: 40px;
        color: white;
        box-shadow: 0 0 15px rgba(0,0,0,0.4);
    }

    .form-container h2 {
        text-align: center;
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .form-container h4 {
        text-align: center;
        font-weight: 400;
        margin-bottom: 30px;
        opacity: 0.9;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: none;
        font-size: 1rem;
    }

    .btn-submit {
        background-color: #00c6ff;
        color: white;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1rem;
        transition: background 0.3s ease;
        text-align: center;
        text-decoration: none;
        width: 100%;
    }

    .btn-submit:hover {
        background-color: #007acc;
    }

    footer {
        margin-top: 30px;
        text-align: center;
        font-size: 0.85rem;
        color: #eee;
    }
</style>

<div class="form-container">
    <h2>?? Abrir Chamado</h2>
    <h4>Classifique o serviço e descreva o problema</h4>

    <form asp-action="Abrir" method="post">
        <div class="form-group">
            <label for="Servico">Serviço</label>
            <select id="Servico" name="Servico" class="form-control" onchange="atualizarCategorias()">
                <option value="">Selecione...</option>
                <option value="Hardware">??? Hardware</option>
                <option value="Software">?? Software</option>
                <option value="Redes">?? Redes</option>
                <option value="Telefonia">?? Telefonia</option>
            </select>
        </div>

        <div class="form-group">
            <label for="Categoria">Categoria</label>
            <select id="Categoria" name="Categoria" class="form-control" onchange="atualizarSubcategorias()">
                <option value="">Selecione um serviço primeiro</option>
            </select>
        </div>

        <div class="form-group">
            <label for="Subcategoria">Subcategoria</label>
            <select id="Subcategoria" name="Subcategoria" class="form-control" onchange="atualizarTitulo()">
                <option value="">Selecione uma categoria primeiro</option>
            </select>
        </div>

        <div class="form-group">
            <label for="Titulo">Título do Chamado</label>
            <input id="Titulo" name="Titulo" class="form-control" readonly />
        </div>

        <div class="form-group">
            <label for="Descricao">Descrição do problema</label>
            <textarea id="Descricao" name="Descricao" class="form-control" rows="5" placeholder="Descreva o problema com detalhes..."></textarea>
        </div>

        <button type="submit" class="btn-submit">?? Enviar Chamado</button>
    </form>

    <div id="faqSugestao" style="display:none; margin-top:20px;">
        <h4>?? Sugestão para resolver o problema:</h4>
        <p id="faqTexto" style="margin-bottom:15px;"></p>
        <p>Essa sugestão resolveu seu problema?</p>
        <button onclick="faqResolvido(true)" class="btn-submit" style="background-color:#28a745;">? Sim, resolvido</button>
        <button onclick="faqResolvido(false)" class="btn-submit" style="background-color:#dc3545;">? Não, continuar com chamado</button>
    </div>

    <div id="iaResposta" style="display:none; margin-top:20px;">
        <h4>?? Sugestão da IA:</h4>
        <p id="iaTexto" style="margin-bottom:15px;"></p>
        <p>Essa sugestão resolveu seu problema?</p>
        <button onclick="iaResolvido(true)" class="btn-submit" style="background-color:#28a745;">? Sim, resolvido</button>
        <button onclick="iaResolvido(false)" class="btn-submit" style="background-color:#dc3545;">? Não, continuar com chamado</button>
    </div>

    <footer>
        Este site é seguro e foi desenvolvido pela equipe do CATI.
    </footer>
</div>

<script>
    const categorias = {
        "Hardware": ["Desktop", "Notebook", "Impressora"],
        "Software": ["Sistema", "Aplicativo", "Atualização"],
        "Redes": ["Wi-Fi", "Cabo", "VPN"],
        "Telefonia": ["Ramal", "Chamada", "Configuração"]
    };

    const subcategorias = {
        "Desktop": ["Configuração", "Sem imagem", "Lento"],
        "Notebook": ["Bateria", "Tela quebrada", "Teclado"],
        "Impressora": ["Sem papel", "Erro de impressão", "Conexão falha"],
        "Sistema": ["Erro de login", "Permissão", "Tela travada"],
        "Aplicativo": ["Não abre", "Erro ao salvar", "Atualização"],
        "Atualização": ["Falha", "Versão incompatível"],
        "Wi-Fi": ["Sem conexão", "Sinal fraco", "Queda constante"],
        "Cabo": ["Sem sinal", "Porta danificada"],
        "VPN": ["Instabilidade", "Não conecta"],
        "Ramal": ["Mudo", "Sem linha", "Chamada externa"],
        "Chamada": ["Interrupção", "Eco", "Ruído"],
        "Configuração": ["Desvio de chamadas", "Toque personalizado"]
    };

    const faq = {
        "Redes|Wi-Fi|Queda constante": "Desligue o modem da tomada, aguarde 15 segundos e ligue novamente.",
        "Telefonia|Ramal|Mudo": "Verifique se o cabo do telefone está bem conectado e se há sinal no aparelho.",
        "Hardware|Desktop|Lento": "Reinicie o computador e feche programas em segundo plano.",
        "Software|Sistema|Erro de login": "Verifique se o CAPS LOCK está ativado e tente redefinir sua senha."
    };

    function atualizarCategorias() {
        const servico = document.getElementById("Servico").value;
        const categoria = document.getElementById("Categoria");
        const subcategoria = document.getElementById("Subcategoria");
        categoria.innerHTML = "";
        subcategoria.innerHTML = "<option value=''>Selecione uma categoria primeiro</option>";
        document.getElementById("Titulo").value = "";

        if (categorias[servico]) {
            categorias[servico].forEach(item => {
                const opt = document.createElement("option");
                opt.value = item;
                opt.innerHTML = item;
                categoria.appendChild(opt);
            });
        }
    }

    function atualizarSubcategorias() {
        const categoria = document.getElementById("Categoria").value;
        const subcategoria = document.getElementById("Subcategoria");
        subcategoria.innerHTML = "";
        document.getElementById("Titulo").value = "";

        if (subcategorias[categoria]) {
            subcategorias[categoria].forEach(item => {
                const opt = document.createElement("option");
                opt.value = item;
                opt.innerHTML = item;
                subcategoria.appendChild(opt);
            });
        }
    }

        function atualizarTitulo() {
        const servico = document.getElementById("Servico").value;
        const categoria = document.getElementById("Categoria").value;
        const subcategoria = document.getElementById("Subcategoria").value;
        const titulo = `${servico} - ${categoria} - ${subcategoria}`;
        document.getElementById("Titulo").value = titulo;

        const chave = `${servico}|${categoria}|${subcategoria}`;
        if (faq[chave]) {
            document.getElementById("faqTexto").innerText = faq[chave];
            document.getElementById("faqSugestao").style.display = "block";
            document.getElementById("iaResposta").style.display = "none";
            document.querySelector("form").style.display = "none";
        } else {
            document.getElementById("faqSugestao").style.display = "none";
            buscarSugestaoIA(); // Chama IA se não houver sugestão no FAQ
        }
    }

    function faqResolvido(resolvido) {
        if (resolvido) {
            window.location.href = "/Cliente/Dashboard";
        } else {
            document.getElementById("faqSugestao").style.display = "none";
            document.querySelector("form").style.display = "block";
        }
    }

    async function buscarSugestaoIA() {
        const servico = document.getElementById("Servico").value;
        const categoria = document.getElementById("Categoria").value;
        const subcategoria = document.getElementById("Subcategoria").value;

        if (!servico || !categoria || !subcategoria) return;

        try {
            const response = await fetch("/Chamado/SugestaoIA", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ servico, categoria, subcategoria })
            });

            const data = await response.json();
            document.getElementById("iaTexto").innerText = data.sugestao;
            document.getElementById("iaResposta").style.display = "block";
            document.querySelector("form").style.display = "none";
        } catch (error) {
            console.error("Erro ao buscar sugestão da IA:", error);
        }
    }

    function iaResolvido(resolvido) {
        if (resolvido) {
            window.location.href = "/Cliente/Dashboard";
        } else {
            document.getElementById("iaResposta").style.display = "none";
            document.querySelector("form").style.display = "block";
        }
    }
</script>
